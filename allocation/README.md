# Asset Allocation Strategy System

This module provides a comprehensive asset allocation system that determines investment allocations based on SPX regime analysis results and performs detailed analysis for each asset sleeve.

## Overview

The allocation system:
1. Reads SPX regime analysis results from `docs/spx-regime-results.json`
2. Determines asset allocation percentages based on regime conditions
3. Analyzes each asset sleeve to determine specific investment opportunities
4. Outputs results to `docs/allocation-results.json` for GitHub Pages

## Directory Structure

```
allocation/
├── __init__.py
├── allocation_engine.py      # Main orchestrator
├── regime_allocator.py        # Determines allocation percentages from regime
├── config.py                  # Configuration and allocation rules
├── utils.py                   # Shared utilities (data loading, I/O)
├── README.md                  # This file
└── sleeves/                   # Asset sleeve analyzers
    ├── __init__.py
    ├── equity.py              # Equity analysis (all sub-modules)
    ├── commodities.py         # Commodities/Metals analysis
    ├── crypto.py              # Crypto analysis
    ├── managed_futures.py     # Managed Futures analysis
    ├── alternatives.py        # Alternatives analysis
    └── fixed_income.py        # Fixed Income analysis
```

## Key Components

### `allocation_engine.py`
Main entry point that orchestrates the entire allocation process. It:
- Loads SPX regime results
- Determines allocation percentages
- Runs analysis for each enabled sleeve
- Aggregates and saves results

### `regime_allocator.py`
Determines asset allocation percentages based on SPX regime conditions:
- **Risk-On** (green background, above 200 MA, low VIX): Higher equity allocation
- **Moderate Risk** (yellow background): Balanced allocation
- **Elevated Risk** (orange background): Reduced equity, increased fixed income
- **Risk-Off** (red background, below 200 MA, high VIX): Minimal equity, high fixed income

### `sleeves/equity.py`
Contains all equity sub-module analyzers:
- `analyze_ex_us()` - Ex-US equity analysis
- `analyze_us_large_cap()` - US Large Cap analysis
- `analyze_small_caps()` - Small Caps analysis
- `analyze_total_market()` - Total Market analysis
- `analyze_sector_etfs()` - Sector ETFs analysis
- `analyze_custom_etfs()` - Custom ETFs analysis
- `analyze_equity_sleeve()` - Main function that runs all enabled sub-modules

### Other Sleeve Analyzers
Each sleeve has its own analyzer function:
- `sleeves/commodities.py` - `analyze_commodities()`
- `sleeves/crypto.py` - `analyze_crypto()`
- `sleeves/managed_futures.py` - `analyze_managed_futures()`
- `sleeves/alternatives.py` - `analyze_alternatives()`
- `sleeves/fixed_income.py` - `analyze_fixed_income()`

## Usage

### Running the Allocation Engine

```python
from allocation.allocation_engine import main

# Configure logging first
import logging
logging.basicConfig(level=logging.INFO)

# Run the allocation analysis
main()
```

Or from command line:
```bash
python allocation/allocation_engine.py
```

### Configuration

Edit `config.py` to:
- Adjust allocation rules for different regime conditions
- Enable/disable specific sleeves
- Configure equity sub-modules
- Set output options (JSON, PNG, HTML)

## Development Approach

This system is designed for incremental development:

1. **Phase 1**: ✅ Directory structure and skeleton files (completed)
2. **Phase 2**: Implement `regime_allocator.py` with basic allocation logic (completed)
3. **Phase 3**: Implement `allocation_engine.py` orchestrator (completed)
4. **Phase 4**: Implement individual sleeve analyzers incrementally (in progress)
5. **Phase 5**: Create GitHub workflow
6. **Phase 6**: Add visualization/output formatting

## Integration Points

- **Input**: `docs/spx-regime-results.json` (generated by SPX regime workflow)
- **Data Access**: CSV files in `data/` directory (from `fetch_data.py`)
- **Output**: `docs/allocation-results.json` (for GitHub Pages)
- **Workflow**: Runs after SPX regime analysis completes

## Adding New Analysis Logic

To add analysis logic to a sleeve:

1. Open the appropriate sleeve file (e.g., `sleeves/equity.py`)
2. Implement the analysis function (e.g., `analyze_ex_us()`)
3. The function should:
   - Load required data from `data/` directory
   - Perform analysis
   - Return a dictionary with:
     - `assets`: List of recommended assets
     - `weights`: Dictionary mapping assets to weights
     - `allocation`: Total allocation percentage

Example:
```python
def analyze_ex_us(data_dir: Path, symbols: Optional[List[str]] = None) -> Dict:
    # Load data
    df = load_csv_data('VEA.csv', data_dir)  # Example: Vanguard FTSE Developed Markets
    
    # Perform analysis
    # ... your analysis logic ...
    
    # Return results
    return {
        'sleeve': 'equity',
        'sub_module': 'ex_us',
        'assets': ['VEA', 'VXUS'],
        'weights': {'VEA': 0.6, 'VXUS': 0.4},
        'allocation': 0.15
    }
```

## GitHub Workflow

The allocation strategy runs via GitHub Actions workflow (`.github/workflows/run-allocation-strategy.yml`) that:
- Triggers after SPX regime analysis completes
- Sets up Python/Conda environment
- Runs `allocation/allocation_engine.py`
- Deploys results to `gh-pages` branch

## Output Format

The allocation results JSON structure:
```json
{
  "datetime": "2024-01-15T10:30:00",
  "regime": {
    "background_color": "green",
    "above_200ma": true,
    "vix_close": 15.5,
    "datetime": "2024-01-15T10:00:00"
  },
  "allocation_percentages": {
    "equity": 0.60,
    "fixed_income": 0.20,
    "commodities": 0.10,
    "crypto": 0.05,
    "managed_futures": 0.03,
    "alternatives": 0.02
  },
  "sleeve_analyses": {
    "equity": {
      "sleeve": "equity",
      "allocation_percentage": 0.60,
      "sub_modules": [...],
      "aggregated_assets": {...},
      "total_allocation": 0.60
    },
    ...
  }
}
```

## Next Steps

1. Implement analysis logic for each sleeve incrementally
2. Test each sleeve analyzer independently
3. Integrate with GitHub workflow
4. Add visualization capabilities (PNG/HTML output)
